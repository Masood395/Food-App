package com.tap.servlet.addcartcntrl;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.tap.cartdaoimpl.CartDAOImpl;
import com.tap.cartitem.CartItem;
import com.tap.menu.Menu;
import com.tap.menudao.MenuDAO;
import com.tap.menudaoimpl.MenuDaoImpl;

@WebServlet("/addcartcntrl")
public class AddCartCntrl extends HttpServlet {
    
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {

        // Retrieve the existing cart from the session, or create a new one if it doesnâ€™t exist
        Map<Integer, CartItem> cart = (Map<Integer, CartItem>) req.getSession().getAttribute("cart");
        if (cart == null) {
            cart = new HashMap<>();
        }

        int menuid = Integer.parseInt(req.getParameter("id"));    
        int quantity = Integer.parseInt(req.getParameter("quantity"));
        String image = req.getParameter("img");
        
        // Retrieve the menu item details
        MenuDAO mdaoi = new MenuDaoImpl();
        Menu menuItem = mdaoi.getById(menuid);
        
        // Check if the item is already in the cart
        CartItem cartItem = cart.get(menuid);
        if (cartItem == null) {
            // If the item is not in the cart, add a new CartItem
            cartItem = new CartItem(menuid, menuItem.getRestaurantId(), menuItem.getMenuName(), quantity, menuItem.getPrice(), image);
        } else {
            // If the item is already in the cart, update the quantity
            cartItem.setQuantity(cartItem.getQuantity() + quantity);
        }
        
        // Update the cart with the new or modified item
        cart.put(menuid, cartItem);
        
        // Save the updated cart in the session
        req.getSession().setAttribute("cart", cart);
        
        // Redirect to the appropriate page
        resp.sendRedirect("getMenu.jsp");
    }
}
